"""
Interface Gr√°fica Corrigida
"""
import FreeSimpleGUI as sg
import simulacao
import matplotlib.pyplot as plt
import matplotlib as mpl
mpl.rcParams['toolbar'] = 'None'
import json
import os

sg.theme("DarkBlue14")

def mostrar_dashboard(res):
    try:
        plt.close('all')
        plt.style.use('seaborn-v0_8-darkgrid') 
        plt.figure("Resultados", figsize=(10, 6))

        plt.subplot(2, 1, 1)
        x, y = res['plot_fila']
        plt.step(x, y, where='post', color='#00d2d3', linewidth=2, label='Fila')
        plt.fill_between(x, y, step='post', color='#00d2d3', alpha=0.2)
        plt.title(f"Fila (M√°x: {res['max_fila']})")
        plt.legend()

        plt.subplot(2, 1, 2)
        x2, y2 = res['plot_ocup']
        plt.plot(x2, y2, color='#ff9f43', label='Ocupa√ß√£o Inst.', linewidth=1)
        plt.axhline(y=res['ocupacao_media'], color='red', linestyle='--', label=f'M√©dia Total: {res["ocupacao_media"]:.1f}%')
        plt.title("Ocupa√ß√£o M√©dica")
        plt.ylim(-5, 105) # Garante que visualmente n√£o passa dos 100
        plt.legend()
        
        plt.tight_layout()
        plt.show(block=False)
    except:
        pass

def mostrar_grafico_sensibilidade(x, y):
    try:
        plt.figure("Stress Test", figsize=(8, 5))
        plt.plot(x, y, color='#ff5252', marker='o')
        plt.title("Sensibilidade da Fila")
        plt.xlabel("Doentes/Hora")
        plt.grid(True)
        plt.tight_layout()
        plt.show(block=False)
    except:
        pass

def mostrar_grafico_pizza(res):
    if 'contagem_especialidade' not in res:
        sg.popup_error("N√£o h√° dados de especialidade para gerar gr√°fico de pizza.")
    else:
        dados = res['contagem_especialidade']
        labels = list(dados.keys())
        valores = list(dados.values())

        if sum(valores) == 0:
            sg.popup_error("Nenhum paciente atendido para gerar gr√°fico de pizza.")
        else:
            plt.figure("Distribui√ß√£o por Especialidade", figsize=(6,6))
            cores = ['#3498db','#2ecc71','#f1c40f','#e74c3c','#9b59b6']  # cores para cada especialidade
            plt.pie(valores, labels=labels, autopct='%1.1f%%', startangle=140, colors=cores)
            plt.title("Distribui√ß√£o de Pacientes por Especialidade")
            plt.axis('equal')  # c√≠rculo perfeito
            plt.show(block=False)


def main():
    layout_params = [
        [sg.Text("CONFIGURA√á√ÉO", font=("Arial", 10, "bold"), text_color="#54a0ff")],
        [sg.Text("Pacientes/Hora:", size=(15,1)), sg.Slider((5, 50), 15, orientation='h', size=(25, 15), key='-TAXA-')],
        [sg.Text("N¬∫ M√©dicos:", size=(15,1)), sg.Spin(list(range(1, 15)), 4, size=(5,1), key='-MEDICOS-')],
        [sg.Text("T. Base (min):", size=(15,1)), sg.Input("15", size=(6,1), key='-TEMPO-')],
        [sg.Text("Distribui√ß√£o:", size=(15,1)), sg.Combo(["Exponencial", "Normal", "Uniforme"], "Exponencial", key='-DIST-')],
        [sg.HSeparator(pad=(0, 20))],
        [sg.Button("SIMULAR ‚ñ∂", size=(30, 2), button_color=("white", "#10ac84"), font=("Arial", 10, "bold"))]
    ]

    layout_kpis = [
        [sg.Text("RESULTADOS M√âDIOS", font=("Arial", 10, "bold"), text_color="#54a0ff")],
        [sg.Text("Total Atendidos:", size=(20,1)), sg.Text("0", key='-TOT-', font=("Arial", 10, "bold"))],
        [sg.Text("Espera M√©dia:", size=(20,1)), sg.Text("0.0 m", key='-ESP-', text_color="orange", font=("Arial", 10, "bold"))],
        [sg.Text("Tempo na Cl√≠nica:", size=(20,1)), sg.Text("0.0 m", key='-CLINICA-', font=("Arial", 10, "bold"))],
        [sg.Text("Ocupa√ß√£o M√©dia:", size=(20,1)), sg.Text("0.0 %", key='-OCUP-', text_color="green", font=("Arial", 10, "bold"))],
        [sg.Text("Fila M√°xima:", size=(20,1)), sg.Text("0", key='-MAXFILA-', font=("Arial", 10, "bold"))],
    ]

    layout_equipa = [
        [sg.Text("Ocupa√ß√£o por M√©dico", font=("Arial", 11))],
        [sg.Listbox(values=[], size=(55, 10), key='-LISTA-', font=("Consolas", 10))]
    ]

    layout_logs = [
        [sg.Text("Log (Nome | Idade | Pulseira | Esp)", font=("Arial", 11))],
        [sg.Multiline(size=(60, 15), key='-LOG_VIEW-', font=("Consolas", 8), disabled=True, background_color="#222f3e", text_color="#c8d6e5")]
    ]

    layout_stress = [
        [sg.Text("AN√ÅLISE SENSIBILIDADE", font=("Arial", 12, "bold"), text_color="#ff5252")],
        [sg.Button("EXECUTAR TESTE üìà", size=(30, 2), button_color=("white", "#ff5252"), font=("Arial", 10, "bold"))]
    ]

    layout_relatorio = [
        [sg.Text("RELAT√ìRIO", font=("Arial", 12, "bold"), text_color="#54a0ff")],
        [sg.Button("üìä Fila & Ocupa√ß√£o", key='-REL_DASH-', size=(30,2))],
        [sg.Button("ü•ß Distribui√ß√£o por Especialidade", key='-REL_PIZZA-', size=(30,2))]
    ]

    layout = [
        [sg.Text("üè• SIMULADOR CL√çNICO FINAL", font=("Verdana", 14, "bold"), text_color="white", pad=(10,10))],
        [sg.TabGroup([
            [sg.Tab("Controlo", [[sg.Column(layout_params), sg.VSeparator(), sg.Column(layout_kpis)]]),
             sg.Tab("Equipa", layout_equipa),
             sg.Tab("Logs", layout_logs),
             sg.Tab("Stress Test", layout_stress, element_justification='c'),
             sg.Tab("Relat√≥rio", layout_relatorio)]
        ], tab_location='topleft', font=("Arial", 10))],
        [
            sg.Text("Pronto.", key='-STATUS-', size=(40,1), relief=sg.RELIEF_SUNKEN, text_color="gray"),
            sg.Push(),
            sg.Button("‚ùå SAIR", size=(10,1), button_color=("white", "#ee5253"))
        ]
    ]
    
    ultimo_resultado = None

    window = sg.Window("Simula√ß√£o Biom√©dica", layout, finalize=True)

    running = True
    while running:
        event, values = window.read()
        if event in (sg.WIN_CLOSED, "‚ùå SAIR"):
            if sg.popup_yes_no("Tem a certeza que quer sair?") == "Yes":
                running = False

        if event == "SIMULAR ‚ñ∂":
            try:
                window['-STATUS-'].update("A simular...")
                window.refresh()
                
                
            # --- CARREGAR JSON DE FORMA SEGURA (CAMINHO ABSOLUTO) ---
                BASE_DIR = os.path.dirname(os.path.abspath(__file__))
                JSON_PATH = os.path.join(BASE_DIR, "pessoas.json")

                db = []
                if os.path.exists(JSON_PATH):
                    try:
                        with open(JSON_PATH, "r", encoding="utf-8") as f:
                            db = json.load(f)
                    except Exception as e:
                        print("Erro a ler pessoas.json:", e)
                else:
                    print("pessoas.json N√ÉO encontrado em:", JSON_PATH)



                cfg = {
                    'taxa_chegada': float(values['-TAXA-']),
                    'num_medicos': int(values['-MEDICOS-']),
                    'tempo_medio': float(values['-TEMPO-']),
                    'distribuicao': values['-DIST-'],
                    'tempo_max': 480
                }
                
                res = simulacao.simular_atendimento(cfg, db)
                ultimo_resultado = res

                window['-TOT-'].update(res['total'])
                window['-ESP-'].update(f"{res['media_espera']:.1f} m")
                window['-CLINICA-'].update(f"{res['media_clinica']:.1f} m")
                window['-OCUP-'].update(f"{res['ocupacao_media']:.1f} %")
                window['-MAXFILA-'].update(res['max_fila'])
                
                window['-LISTA-'].update(res['stats_equipa'])
                
                if os.path.exists("relatorio_final.txt"):
                    with open("relatorio_final.txt","r",encoding="utf-8") as f:
                        window['-LOG_VIEW-'].update(f.read())

                window['-STATUS-'].update("Conclu√≠do.")
                
            except Exception as e:
                sg.popup_error(f"Erro: {e}")

        if event == '-REL_DASH-' and ultimo_resultado:
            mostrar_dashboard(ultimo_resultado)

        if event == '-REL_PIZZA-' and ultimo_resultado:
            mostrar_grafico_pizza(ultimo_resultado)

        if event == "EXECUTAR TESTE üìà":
            try:
                window['-STATUS-'].update("A testar...")
                window.refresh()
                cfg_base = {
                    'taxa_chegada': 10,
                    'num_medicos': int(values['-MEDICOS-']),
                    'tempo_medio': float(values['-TEMPO-']),
                    'distribuicao': values['-DIST-'],
                    'tempo_max': 480
                }
                x, y = simulacao.realizar_analise_sensibilidade(cfg_base)
                window['-STATUS-'].update("Teste terminado.")
                mostrar_grafico_sensibilidade(x, y)
            except Exception as e:
                sg.popup_error(f"Erro: {e}")

    window.close()

if __name__ == "__main__":
    main()
